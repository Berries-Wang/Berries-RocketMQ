# RocketMQ 消息处理流程
RocketMQ 的消息处理流程主要涉及生产者、Broker 和消费者三个核心组件。以下是详细流程：

---

### 1. **消息发送（Producer 阶段）**
- **创建消息**：生产者创建消息，指定 Topic、Tag、Key 和消息体。
- **选择队列**：根据负载均衡策略（如轮询、哈希）选择一个消息队列（MessageQueue）。
- **发送消息**：将消息发送到 Broker。
- **Broker 接收**：Broker 接收消息并存储到 CommitLog（持久化日志文件）。
- **返回结果**：Broker 返回发送结果（成功或失败）给生产者。

---

### 2. **消息存储（Broker 阶段）**
- **写入 CommitLog**：所有消息按顺序写入 CommitLog 文件，确保消息持久化。
- **构建索引**：Broker 为消息创建索引（ConsumeQueue 和 IndexFile），方便快速查找。
  - **ConsumeQueue**：按 Topic 和 Queue 存储消息的物理偏移量，用于消费者拉取消息。
  - **IndexFile**：提供基于 Key 或时间戳的消息检索功能。
- **异步刷盘**：根据配置（同步或异步刷盘），将消息从内存刷入磁盘。

---

### 3. **消息拉取（Consumer 阶段）**
- **订阅 Topic**：消费者订阅指定的 Topic 和 Tag。
- **拉取消息**：消费者向 Broker 发送拉取请求，从 ConsumeQueue 中获取消息的物理偏移量，再根据偏移量从 CommitLog 读取消息内容。
- **负载均衡**：消费者组内的多个消费者通过负载均衡策略分配消息队列。
- **消息过滤**：消费者根据 Tag 或 SQL 表达式过滤消息。

---

### 4. **消息消费（Consumer 阶段）**
- **处理消息**：消费者从 Broker 拉取消息后，调用业务逻辑处理消息。
- **提交消费位点**：消息处理成功后，消费者将消费位点（Offset）提交给 Broker。
- **重试机制**：若消费失败，消息会进入重试队列，稍后重新投递。

---

### 5. **消息清理（Broker 阶段）**
- **过期清理**：根据配置的保留时间（默认 72 小时），清理过期的 CommitLog 和 ConsumeQueue。
- **文件删除**：定期删除不再需要的 CommitLog 和索引文件。

---

### 6. **消息重试与死信（特殊场景）**
- **重试队列**：若消息消费失败，RocketMQ 会将消息放入重试队列，稍后重新投递。
- **死信队列**：若消息重试多次仍失败，会被转移到死信队列，由人工处理。

---

### 总结
RocketMQ 的消息处理流程包括：
1. 生产者发送消息到 Broker。
2. Broker 存储消息并构建索引。
3. 消费者拉取并处理消息。
4. Broker 清理过期消息。

通过这一流程，RocketMQ 实现了高吞吐、低延迟的消息传递，同时支持消息持久化、负载均衡和故障恢复。