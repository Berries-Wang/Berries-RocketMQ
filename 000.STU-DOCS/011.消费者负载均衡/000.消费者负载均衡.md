# 消费者负载均衡
> 阅读:[消费者负载均衡](./消费者负载均衡%20_%20RocketMQ.pdf) , [阿里云消息系列公开课 vol.4 ——《RocketMQ 全新负载均衡机制解析》](../../005.LESSONS/c3c64ad04ad35959_mp4_355043849595_mp4_264_hd_taobao.mp4)

+ 4.x 3.x 版本的RocketMQ 只支持队列粒度的消费者负载均衡
   - 通过文档，此种如果消息都堆积在某一个Consumer上时，只能修改队列数量
     ```shell
        # 在创建Topic时，指定队列数量
        # sh mqadmin updateTopic -n <nameserver地址> -t <Topic名称> -c <集群名称> -w <队列数量>
        sh mqadmin updateTopic -n localhost:9876 -t TestTopic -c DefaultCluster -w 16
     ```
   - 重要!!!  `队列粒度负载均衡策略中，同一消费者分组内的多个消费者将按照队列粒度消费消息，即每个队列仅被一个消费者消费`
   - `队列粒度负载均衡策略保证同一个队列仅被一个消费者处理`，该策略的实现依赖消费者和服务端的信息协商机制，Apache RocketMQ 并不能保证协商结果完全强一致。因此，在消费者数量、队列数量发生变化时，可能会出现短暂的队列分配结果不一致，从而导致少量消息被重复处理。
   - 注意事项:
     ```txt
          1. 在整个Topic的生命周期中，消息队列的数量并不会自动调整。
          2. 从文档来看，当消费者数量远大于消息队列的数量，此时是没有意义的。更好的处理方案是 缩减消费者数量（应大于消息队列数量），将单个消费者的配置升高（CPU ， 内存 ， 消费线程数量）
          》 阿里官方产研确认
     ```
+ 5.x 版本的RocketMQ 支持消息粒度的消费者负载均衡策略

## 负载均衡机制
### 负载均衡时机
负载均衡是客户端和服务端相互配合的过程。
1. 客户端主动负载均衡
   - MQClientInstance：相关方法： rebalanceImmediately 和 doRebalance
     1. 启动时立即进行负载均衡
     2. 定时（默认20秒）负载均衡一次

2. 服务端通知负载均衡
   - 服务端通知客户端进行负载均衡也是通过 MQClientInstance#rebalanceImmediately 方法实现的
     1. 客户端上下线
     2. 订阅关系变化

### 负载均衡策略
负载均衡实际是变更消费者负责处理的队列数量。负载均衡策略：
1. 平均分配 （默认）
2. 一致性哈希
   - 基于一致性哈希算法的负载均衡策略每次负载均衡会重新分配尽可能少<sub>相对于平均分配策略来说</sub>的队列数量，但是可能出现负载不均的情况

### 负载均衡对消费的影响
注意！
1. 上下线时会因为负载均衡带来短暂的消息`处理延迟`，新的消费者会从服务端获取消费位点继续之前的消费进度。`如果消费者异常宕机或没有调用shutdown优雅下线，没有上传自己的最新消费位点，会使得新分配的消费者重复消费`

因此，当某个客户端触发负载均衡时：
1. 对于新分配的队列可能会重复消费，故 需要做好消息幂等
2. 对于不再负责的队列会暂时停止消费，如果原本的消费TPS很高或者正好出现生产高峰就会造成消费毛刺

## 最佳实践
### 1. 避免频繁上下线
为了避免负载均衡的影响应该尽量减少客户端的上下线，同时做好消费幂等。

同时在有应用重启或下线前要调用 shutdown 方法，这样服务端在收到客户端的下线请求后会通知客户端及时触发负载均衡，减少消费延迟。
### 2. 选择合适的负载均衡策略
需要根据业务需要灵活选择负载均衡策略：
- 需要保证客户端的负载尽可能的均衡：选择默认的平均分配策略；
- 需要降低应用重启带来的消费延迟：选择一致性哈希的分配策略。 
- 当然还有其他负载均衡策略由于时间关系不一一介绍了，留给读者自行探索。

### 3. 保证客户端订阅一致
RocketMQ 的负载均衡是每个客户端独立进行计算，所以务必要保证每个客户端的负载均衡算法和订阅语句一致。
- 负载均衡策略不一致会导致多个客户端分配到相同队列或有客户端分不到队列；
- 订阅语句不一致会导致有消息未能消费。 

### 5A.Final(终极方案) RocketMQ5.0
> 为了彻底解决客户端负载均衡导致的重复消费和消费延迟问题，RocketMQ 5.0 提出了消息级别的负载均衡机制。


## 参考
1. [RocketMQ 客户端负载均衡机制详解及最佳实践](./RocketMQ%20客户端负载均衡机制详解及最佳实践.png)